#!/usr/bin/env ruby

#$LOAD_PATH << File.join(File.dirname(__FILE__), 'lib')

require "lib/menu"
require "lib/config"
require "lib/users"

begin
  Config.initialize
  Dir.chdir Config.config["server"]["path"]
  #Users.load
  ENV.each_key do |k|
    case k
    when "LANG", "LANGUAGE", /\ALC_/: ENV.delete k
    end
    ENV["LANG"] = "en_US.UTF-8" #should this be in the config?
  end
  Signal.trap "HUP" do
    Menu.destroy
    if Games.socket then
      system "screen", "-D", Games.socket
    end
    exit 1
  end
  Signal.trap "USR1" do
    Config.initialize
  end
  Menu.initialize
  if ARGV[0] then
    userinfo = Users.usercoll.find_one('name' => ARGV[0])
    if userinfo then
      Menu.user = {'name' => userinfo['name']}
    end
  end
  Menu.mainmenu
ensure
  Menu.destroy
end
